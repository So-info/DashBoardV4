<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Plage â€“ Dashboard</title>
  <meta name="theme-color" content="#e6f4ff" />
  <!-- Tailwind via CDN (mobile-first, no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            skybrand: {
              50: '#f0f9ff', 100: '#e0f2ff', 200: '#bae6fd', 300: '#7dd3fc',
              400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
              800: '#075985', 900: '#0c4a6e'
            }
          },
          boxShadow: { soft: '0 10px 25px -10px rgba(2, 132, 199, 0.25)' }
        }
      }
    }
  </script>
  <style>
    :root {
      --radius: 18px;
      /* Theme: sky (default) */
      --brand-50:#eef7ff; --brand-100:#d9efff; --brand-200:#b3e0ff; --brand-300:#84ccff; --brand-400:#49b7ff;
      --brand-500:#1a9cf7; --brand-600:#0d7ed1; --brand-700:#0b67ab; --brand-800:#0a5388; --brand-900:#0a446f;
      --bg-grad-1:#d9efff; --bg-grad-2:#b3e0ff;
    }
    /* Theme: ocean */
    :root[data-theme="ocean"]{
      --brand-50:#e8fbff; --brand-100:#d1f6ff; --brand-200:#a4ecff; --brand-300:#6fe1ff; --brand-400:#33d1ff;
      --brand-500:#08b6ea; --brand-600:#0796c1; --brand-700:#07799b; --brand-800:#065f7a; --brand-900:#054c62;
      --bg-grad-1:#d1f6ff; --bg-grad-2:#a4ecff;
    }
    /* Theme: sand */
    :root[data-theme="sable"]{
      --brand-50:#fff8ec; --brand-100:#fff0d6; --brand-200:#ffe1ad; --brand-300:#ffd07e; --brand-400:#ffc057;
      --brand-500:#f2a73a; --brand-600:#d1842b; --brand-700:#a76321; --brand-800:#874f1a; --brand-900:#6d4015;
      --bg-grad-1:#fff0d6; --bg-grad-2:#ffe1ad;
    }

    body { font-feature-settings: 'cv02','cv03','cv04','cv11'; }
    /* Mobile-first helpers */
    .card { border-radius: var(--radius); background: rgba(255,255,255,0.9); box-shadow: var(--tw-shadow), var(--tw-ring-shadow, 0 0 #0000); }
    .btn  { border-radius: 14px; padding: 0.75rem 1rem; font-weight: 700; transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active { transform: scale(.98); }
    .btn-primary { background: linear-gradient(180deg, var(--brand-400), var(--brand-500)); color:#fff; box-shadow: 0 6px 18px -8px rgba(10,83,136,.6); }
    .btn-outline { border: 1px solid var(--brand-400); color:var(--brand-700); background: #fff; }
    .chip { display:inline-flex; align-items:center; gap:.5rem; border-radius:9999px; padding:.25rem .6rem; font-size:.7rem; font-weight:600; }
    .chip.todo { background:color-mix(in oklab, var(--brand-100) 70%, white); color:var(--brand-900); }
    .chip.doing { background:#fff7e6; color:#8a5a00; }
    .chip.done { background:#e9fbf1; color:#046d3a; }
    .chip.lock { background:#eaeaea; color:#494949; }
    .hide { display:none; }

    /* --- Reveal animations --- */
    .reveal { opacity: 0; transform: translateY(10px); transition: opacity .4s ease, transform .4s ease; }
    .reveal.in { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body class="min-h-screen bg-[radial-gradient(60rem_60rem_at_20%_-10%,var(--bg-grad-1)_20%,transparent_60%),radial-gradient(40rem_40rem_at_120%_20%,var(--bg-grad-2)_10%,transparent_50%)] text-brand-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-skybrand-50/80 backdrop-blur border-b border-skybrand-100">
    <div class="max-w-xl mx-auto flex items-center justify-between p-3">
      
      <div class="flex items-center gap-3">
        <img src="logo-camping-la-plage.png" alt="La Plage" class="h-8 w-8 rounded-full"/>
        <h1 class="text-lg font-extrabold tracking-tight">La Plage â€“ Dashboard</h1>
      </div>
      <div class="flex items-center gap-2">
          <div class="hidden sm:flex items-center gap-1 bg-white/60 px-2 py-1 rounded-full shadow-soft text-xs">
            <button class="theme-dot" data-theme="sky" title="Bleu ciel">ðŸ”µ</button>
            <button class="theme-dot" data-theme="ocean" title="OcÃ©an">ðŸŸ¦</button>
            <button class="theme-dot" data-theme="sable" title="Sable">ðŸŸ¨</button>
          </div>
          <div id="userBadge" class="flex items-center gap-2 text-sm bg-white/60 px-2 py-1 rounded-full shadow-soft"></div>
        </div>
    </div>
  </header>

  <!-- LOGIN PAGE (only Google button + logo + welcome message) -->
  <main id="page-login" class="max-w-xl mx-auto px-4 py-10 grid gap-6">
    <div class="card p-6 shadow-ring">
      <div class="text-center">
        <img src="logo-camping-la-plage.png" alt="La Plage" class="mx-auto h-16 w-16 rounded-full ring-2 ring-brand-200 mb-4"/>
        <h2 class="text-3xl font-extrabold leading-tight">Bienvenue sur le dashboard du camping La Plage</h2>
        <p class="mt-2 text-brand-700">AccÃ©dez avec votre compte Google pour continuer.</p>
      </div>
      <button id="btnGoogle" class="btn btn-primary mt-6 w-full flex items-center justify-center gap-3">
        <svg aria-hidden="true" viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M21.35 11.1h-9.18v2.91h5.27c-.23 1.49-1.58 4.37-5.27 4.37-3.18 0-5.77-2.63-5.77-5.86S9 6.66 12.17 6.66c1.81 0 3.03.77 3.73 1.43l2.55-2.47C16.98 4.34 14.86 3.5 12.17 3.5 6.95 3.5 2.7 7.79 2.7 13s4.25 9.5 9.47 9.5c5.46 0 9.07-3.84 9.07-9.26 0-.62-.06-1.08-.14-1.64Z"/></svg>
        Continuer avec Google
      </button>
    </div>
  </main>

  <!-- APP SHELL (shown when authenticated) -->
  <section id="app" class="hide max-w-xl mx-auto p-4 pb-24">

    <!-- Role-aware tabs (only relevant tabs appear) -->
    <nav id="tabbar" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-brand-100">
      <div class="max-w-xl mx-auto grid grid-cols-4 gap-1 p-2 text-xs">
        <button data-tab="home" class="btn btn-outline flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M12 3l9 8h-3v9H6v-9H3z"/></svg>Accueil</button>
        <button data-tab="reception" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h12v2H3z"/></svg>RÃ©ception</button>
        <button data-tab="tech" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M22 13v-2h-2.07a7.95 7.95 0 00-1.07-2.57l1.46-1.46-1.41-1.41-1.46 1.46A7.95 7.95 0 0013 4.07V2h-2v2.07a7.95 7.95 0 00-2.57 1.07L6.97 3.68 5.56 5.1l1.46 1.46A7.95 7.95 0 006 9.93H4v2h2.07c.2.92.55 1.78 1.07 2.57L5.68 16.6l1.41 1.41 1.46-1.46c.79.52 1.65.87 2.57 1.07V20h2v-2.07c.92-.2 1.78-.55 2.57-1.07l1.46 1.46 1.41-1.41-1.46-1.46c.52-.79.87-1.65 1.07-2.57H22zM12 15a3 3 0 110-6 3 3 0 010 6z"/></svg>Technique</button>
        <button data-tab="clean" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M5 21h14v-2H5v2zm7-18C8.69 3 6 5.69 6 9c0 3.87 4 9 6 12 2-3 6-8.13 6-12 0-3.31-2.69-6-6-6zm0 8.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg>MÃ©nage</button>
        <button data-tab="inventory-tech" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M20 6H4V4h16v2zm0 4H4v2h16v-2zm0 6H4v2h16v-2z"/></svg>Invent. Tech</button>
        <button data-tab="inventory-clean" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M4 4h16v2H4zm0 6h16v2H4zm0 6h10v2H4z"/></svg>Invent. MÃ©nage</button>
        <button data-tab="admin" class="btn btn-outline hide flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M12 12a5 5 0 100-10 5 5 0 000 10zm-9 9v-1a7 7 0 0114 0v1H3z"/></svg>Admin</button>
        <button id="btnSignOut" class="btn btn-primary flex items-center justify-center gap-2"><svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M10 17l5-5-5-5v10zm-6 4h8v-2H6V5h6V3H4v18z"/></svg>Quitter</button>
      </div>
    </nav>

    <!-- HOME / DASHBOARD -->
    <section id="tab-home" class="tab p-2 mt-2">
      <div class="card p-4 reveal">
        <h2 class="text-xl font-bold">Tableau de bord</h2>
        <p class="mt-1 text-sm">Vous Ãªtes connectÃ© en tant que <span id="roleLabel" class="font-semibold"></span>.</p>
        <div class="mt-4 grid grid-cols-2 gap-3" id="kpiWrap">
          <div class="card p-3 text-center">
            <div class="text-xs opacity-70">Total interventions</div>
            <div id="kpiTotal" class="text-2xl font-extrabold">â€”</div>
          </div>
          <div class="card p-3 text-center">
            <div class="text-xs opacity-70">En cours</div>
            <div id="kpiDoing" class="text-2xl font-extrabold">â€”</div>
          </div>
          <div class="card p-3 text-center">
            <div class="text-xs opacity-70">TerminÃ©es</div>
            <div id="kpiDone" class="text-2xl font-extrabold">â€”</div>
          </div>
          <div class="card p-3 text-center">
            <div class="text-xs opacity-70">Temps moyen (validÃ©es)</div>
            <div id="kpiAvg" class="text-2xl font-extrabold">â€”</div>
          </div>
        </div>
        <div class="mt-4 card bg-white/70 p-3">
          <h3 class="font-semibold">Interventions en cours (Technique)</h3>
          <ul id="dashTechList" class="mt-2 text-sm grid gap-2"></ul>
        </div>
      </div>
    </section>

    <!-- RÃ‰CEPTION: crÃ©er des interventions (technique) -->
    <section id="tab-reception" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold mb-3">Nouvelle intervention (Technique)</h2>
        <form id="formReception" class="grid gap-3">
          <label class="grid gap-1">
            <span>NÂ° Mobil-home</span>
            <input name="mh" required inputmode="numeric" class="w-full rounded-xl border p-3" placeholder="ex: 42" />
          </label>
          <label class="grid gap-1">
            <span>DÃ©tail de l'intervention</span>
            <textarea name="detail" class="w-full rounded-xl border p-3" placeholder="DÃ©crivez le problÃ¨me..."></textarea>
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="present"/> Clients prÃ©sents</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="authorized"/> Autorisation d'entrÃ©e</label>
          </div>
          <button class="btn btn-primary w-full">CrÃ©er l'intervention</button>
        </form>
      </div>

      <div class="card mt-4">
        <h3 class="font-semibold">Toutes les interventions</h3>
        <ul id="receptionList" class="mt-2 grid gap-2"></ul>
      </div>
    </section>

    <!-- TECHNIQUE: voir & traiter interventions -->
    <section id="tab-tech" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold">Interventions</h2>
        <div class="flex gap-2 mt-2 text-sm">
          <button class="btn btn-outline" data-filter="all">Toutes</button>
          <button class="btn btn-outline" data-filter="todo">Ã€ faire</button>
          <button class="btn btn-outline" data-filter="doing">En cours</button>
          <button class="btn btn-outline" data-filter="done">TerminÃ©es</button>
        </div>
        <ul id="techList" class="mt-3 grid gap-3"></ul>
      </div>
    </section>

    <!-- MÃ‰NAGE: placeholder pour Ã©ventuelles interventions mÃ©nage (lecture seule ici) -->
    <section id="tab-clean" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold">Informations mÃ©nage</h2>
        <p class="text-sm">Aucune intervention spÃ©cifique n'est requise ici pour l'instant.</p>
      </div>
    </section>

    <!-- INVENTAIRE TECHNIQUE -->
    <section id="tab-inventory-tech" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold">Inventaire â€“ Technique</h2>
        <form id="formInvTech" class="mt-2 grid grid-cols-3 gap-2">
          <input name="name" class="col-span-2 rounded-xl border p-3" placeholder="Nom de l'objet"/>
          <input name="qty" type="number" value="1" class="rounded-xl border p-3"/>
          <button class="btn btn-primary col-span-3">Ajouter</button>
        </form>
        <ul id="listInvTech" class="mt-3 grid gap-2"></ul>
      </div>
    </section>

    <!-- INVENTAIRE MÃ‰NAGE -->
    <section id="tab-inventory-clean" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold">Inventaire â€“ MÃ©nage</h2>
        <form id="formInvClean" class="mt-2 grid grid-cols-3 gap-2">
          <input name="name" class="col-span-2 rounded-xl border p-3" placeholder="Nom de l'objet"/>
          <input name="qty" type="number" value="1" class="rounded-xl border p-3"/>
          <button class="btn btn-primary col-span-3">Ajouter</button>
        </form>
        <ul id="listInvClean" class="mt-3 grid gap-2"></ul>
      </div>
    </section>

    <!-- ADMIN: gestion des comptes & rÃ´les -->
    <section id="tab-admin" class="tab hide p-2">
      <div class="card">
        <h2 class="text-lg font-bold">Administration â€“ Comptes & rÃ´les</h2>
        <p class="text-sm">Attribuez un rÃ´le aux salariÃ©s dÃ©jÃ  connectÃ©s au moins une fois.</p>
        <ul id="usersList" class="mt-3 grid gap-2"></ul>
      </div>
    </section>

  </section>

  <!-- Firebase + App Logic -->
  <script type="module">
    // --- Config (fourni par vous)
    const firebaseConfig = {
      apiKey: "AIzaSyDEVzQfz8loSf2HDzU_YcBvIgH1Fx9_fnw",
      authDomain: "dashboard-v4-2ef47.firebaseapp.com",
      projectId: "dashboard-v4-2ef47",
      storageBucket: "dashboard-v4-2ef47.firebasestorage.app",
      messagingSenderId: "179267988381",
      appId: "1:179267988381:web:644c3a2dc713ed9bca1d74"
    };

    // Import Firebase (v10+ modular)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, addDoc, collection, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Init
    const appFb = initializeApp(firebaseConfig);
    const auth = getAuth(appFb);
    const db = getFirestore(appFb);

    // UI helpers
// UI helpers
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const showEl = (el) => el.classList.remove('hide');
const hideEl = (el) => el.classList.add('hide');

// Reveal on view
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in'); });
}, { threshold: 0.1 });
const revealify = (el)=>{ el.classList.add('reveal'); io.observe(el); };

// Theme handling
const setTheme = (name)=>{
  document.documentElement.dataset.theme = name==='ocean' ? 'ocean' : name==='sable' ? 'sable' : 'sky';
  localStorage.setItem('lp_theme', document.documentElement.dataset.theme);
};
setTheme(localStorage.getItem('lp_theme')||'sky');
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.theme-dot'); if(!b) return; setTheme(b.dataset.theme);
});
    const show = el => el.classList.remove('hide');
    const hide = el => el.classList.add('hide');

    // Pages / tabs
    const pageLogin = $('#page-login');
    const app = $('#app');
    const userBadge = $('#userBadge');

    const roleTabs = {
      reception: $('[data-tab="reception"]'),
      tech: $('[data-tab="tech"]'),
      clean: $('[data-tab="clean"]'),
      invTech: $('[data-tab="inventory-tech"]'),
      invClean: $('[data-tab="inventory-clean"]'),
      admin: $('[data-tab="admin"]')
    };

    function switchTab(id){
      $$('.tab').forEach(t => hide(t));
      $(`#tab-${id}`).classList.remove('hide');
      // Persist current tab
      localStorage.setItem('lp_tab', id);
    }

    // Tabbar click
    $('#tabbar').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-tab]');
      if(!b) return;
      switchTab(b.dataset.tab);
    });

    // Login
    $('#btnGoogle').addEventListener('click', async ()=>{
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert('Connexion Google refusÃ©e.');
        console.error(err);
      }
    });

    // Sign out
    $('#btnSignOut').addEventListener('click', ()=> signOut(auth));

    // Current user state + role loading
    let unsubIntervReception = null;
    let unsubIntervTech = null;
    let unsubDashTech = null;
    let unsubUsers = null;

    const ROLES = ['admin','reception','tech','clean'];

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // Logged out
        show(pageLogin); hide(app);
        userBadge.innerHTML = '';
        return;
      }

      // First login: create profile doc if missing
      const uref = doc(db, 'users', user.uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        await setDoc(uref, {
          email: user.email || null,
          displayName: user.displayName || null,
          photoURL: user.photoURL || null,
          role: 'reception', // rÃ´le par dÃ©faut minimal
          createdAt: serverTimestamp()
        });
      }

      // Read role
      const role = (await getDoc(uref)).data().role || 'reception';

      // UI toggle
      hide(pageLogin); show(app);
      userBadge.innerHTML = `
        <img src="${user.photoURL || ''}" class="h-6 w-6 rounded-full" alt=""/>
        <span class="hidden sm:inline">${user.displayName || user.email}</span>
      `;
      $('#roleLabel').textContent = role;

      // Show tabs by role
      Object.values(roleTabs).forEach(hide);
      // Everyone gets Home and Sign out; role-specific below
      if(role==='admin'){
        show(roleTabs.reception); show(roleTabs.tech); show(roleTabs.clean);
        show(roleTabs.invTech); show(roleTabs.invClean); show(roleTabs.admin);
      } else if(role==='reception'){
        show(roleTabs.reception); show(roleTabs.invTech); show(roleTabs.invClean);
      } else if(role==='tech'){
        show(roleTabs.tech); show(roleTabs.invTech);
      } else if(role==='clean'){
        show(roleTabs.clean); show(roleTabs.invClean);
      }

      // Restore last tab (or default)
      const last = localStorage.getItem('lp_tab') || (role==='reception'?'reception':role==='tech'?'tech':role==='admin'?'admin':'home');
      switchTab(last);

      // Live dashboard (tech in-progress)
// Live dashboard (tech in-progress)
if (unsubDashTech) unsubDashTech();
unsubDashTech = onSnapshot(
  query(collection(db,'interventions'), where('type','==','tech')),
  (qs)=>{
    // KPIs
    const arr = [];
    qs.forEach(d=>{ const it = {id:d.id, ...d.data()}; arr.push(it); });
    const total = arr.length;
    const doing = arr.filter(x=>x.status==='doing').length;
    const done  = arr.filter(x=>x.status==='done' || x.locked===true).length;
    // average duration (createdAt -> validatedAt) for locked
    const durations = arr
      .filter(x=>x.locked && x.createdAt && x.validatedAt)
      .map(x=> (x.validatedAt.toDate?.()||new Date(x.validatedAt)).getTime() - (x.createdAt.toDate?.()||new Date(x.createdAt)).getTime());
    const avgMs = durations.length ? Math.round(durations.reduce((a,b)=>a+b,0)/durations.length) : 0;
    const fmt = (ms)=>{ if(!ms) return 'â€”'; const m=Math.floor(ms/60000), h=Math.floor(m/60); const mm=(m%60).toString().padStart(2,'0'); return h?`${h}h${mm}`:`${m} min`; };
    $('#kpiTotal').textContent = total;
    $('#kpiDoing').textContent = doing;
    $('#kpiDone').textContent  = done;
    $('#kpiAvg').textContent   = fmt(avgMs);

    // Dashboard list (only not locked shown)
    const ul = $('#dashTechList'); ul.innerHTML='';
    arr.filter(x=>!x.locked).forEach(it=>{
      const li = document.createElement('li');
      li.className = 'flex items-center justify-between gap-2 rounded-xl border p-3 bg-white reveal';
      li.innerHTML = `
        <div>
          <div class="font-semibold">MH ${it.mh} â€“ ${it.detail || ''}</div>
          <div class="text-xs opacity-80">PrÃ©sents: ${it.present? 'oui':'non'} Â· EntrÃ©e: ${it.authorized? 'oui':'non'}</div>
        </div>
        <span class="chip ${it.status==='todo'?'todo':it.status==='doing'?'doing':'done'}">
          ${it.status==='todo'?'Ã€ faire':it.status==='doing'?'En cours':'TerminÃ©e'}
        </span>`;
      ul.appendChild(li);
      revealify(li);
    });
  }
);

// Wire pages depending on role  ðŸ‘‰ (reste DANS onAuthStateChanged)
wireReception(role);
wireTech(role, user);
wireAdmin(role, user);
wireInventories(role);

}); // <-- ceci ferme onAuthStateChanged, une seule fois, ici.

    // ===== Reception logic =====
    function wireReception(role){
      if(role!=='reception' && role!=='admin') return;

      const form = $('#formReception');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          type: 'tech',
          mh: (fd.get('mh')||'').toString().trim(),
          detail: (fd.get('detail')||'').toString().trim(),
          present: !!fd.get('present'),
          authorized: !!fd.get('authorized'),
          status: 'todo',
          locked: false,
          createdAt: serverTimestamp()
        };
        if(!payload.mh){ alert('NumÃ©ro de mobil-home requis'); return; }
        await addDoc(collection(db,'interventions'), payload);
        form.reset();
      });

      // List all interventions (for reception)
      if(unsubIntervReception) unsubIntervReception();
      unsubIntervReception = onSnapshot(query(collection(db,'interventions'), orderBy('createdAt','desc')), (qs)=>{
        const ul = $('#receptionList'); ul.innerHTML='';
        qs.forEach(docu=>{
          const it = {id: docu.id, ...docu.data()};
          const li = document.createElement('li');
          li.className = 'rounded-xl border p-3 bg-white';
          li.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="font-semibold">MH ${it.mh} â€“ ${it.detail || ''}</div>
              <span class="chip ${it.locked?'lock':it.status==='todo'?'todo':it.status==='doing'?'doing':'done'}">
                ${it.locked?'ValidÃ©e': it.status==='todo'?'Ã€ faire':it.status==='doing'?'En cours':'TerminÃ©e'}
              </span>
            </div>
            <div class="mt-1 text-xs opacity-80">Clients prÃ©sents: ${it.present? 'oui':'non'} Â· Autorisation: ${it.authorized? 'oui':'non'}</div>
            ${it.locked && it.validatedByName ? `<div class='mt-1 text-xs'>ValidÃ©e par <b>${it.validatedByName}</b></div>`:''}
          `;
          ul.appendChild(li); revealify(li);
        });
      });
    }

    // ===== Technique logic =====
    function wireTech(role, user){
      if(role!=='tech' && role!=='admin') return;

      const ul = $('#techList');
      let currentFilter = 'all';
      $('#tab-tech').addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-filter]');
        if(b){ currentFilter = b.dataset.filter; render(); }
      });

      let items = [];
      if(unsubIntervTech) unsubIntervTech();
      unsubIntervTech = onSnapshot(query(collection(db,'interventions'), where('type','==','tech'), orderBy('createdAt','desc')), (qs)=>{
        items = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        render();
      });

      function render(){
        ul.innerHTML='';
        items
          .filter(it=> currentFilter==='all' ? true : currentFilter==='done' ? it.status==='done' : currentFilter==='doing' ? it.status==='doing' : it.status==='todo')
          .forEach(it=>{
            const li = document.createElement('li');
            li.className = 'card reveal';
            li.innerHTML = `
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold">MH ${it.mh}</div>
                  <div class="text-sm opacity-80">${it.detail || ''}</div>
                  <div class="text-xs mt-1 opacity-80">PrÃ©sents: ${it.present?'oui':'non'} Â· EntrÃ©e: ${it.authorized?'oui':'non'}</div>
                </div>
                <div>
                  <span class="chip ${it.locked?'lock':it.status==='todo'?'todo':it.status==='doing'?'doing':'done'}">
                    ${it.locked?'ValidÃ©e': it.status==='todo'?'Ã€ faire':it.status==='doing'?'En cours':'TerminÃ©e'}
                  </span>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-3 gap-2">
                <button class="btn btn-outline" data-act="status" data-to="todo" ${it.locked?'disabled':''}>Ã€ faire</button>
                <button class="btn btn-outline" data-act="status" data-to="doing" ${it.locked?'disabled':''}>En cours</button>
                <button class="btn btn-outline" data-act="status" data-to="done" ${it.locked?'disabled':''}>TerminÃ©e</button>
                <button class="btn btn-primary col-span-3" data-act="validate" ${it.locked?'disabled':''}>Valider l'intervention</button>
              </div>
            `;

            li.addEventListener('click', async (e)=>{
              const b = e.target.closest('button[data-act]'); if(!b) return;
              if(b.dataset.act==='status'){
                if(it.locked) return;
                await updateDoc(doc(db,'interventions', it.id), { status: b.dataset.to });
              }
              if(b.dataset.act==='validate'){
                if(it.locked) return;
                await updateDoc(doc(db,'interventions', it.id), {
                  locked: true,
                  validatedBy: user.uid,
                  validatedByName: auth.currentUser?.displayName || auth.currentUser?.email || 'tech',
                  validatedAt: serverTimestamp()
                });
              }
            });

            ul.appendChild(li); revealify(li);
          });
      }
    }

    // ===== Admin logic =====
    function wireAdmin(role, user){
      if(role!=='admin') return;
      const ul = document.querySelector('#usersList');
      if(unsubUsers) unsubUsers();
      unsubUsers = onSnapshot(query(collection(db,'users'), orderBy('createdAt','desc')), async (qs)=>{
        ul.innerHTML='';
        for (const d of qs.docs){
          const u = { id: d.id, ...d.data() };
          const rref = doc(db,'roles', u.id);
          const rs = await getDoc(rref);
          const currentRole = rs.exists() ? rs.data().role : 'reception';
          const li = document.createElement('li');
          li.className = 'rounded-xl border p-3 bg-white flex items-center gap-3 justify-between';
          li.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${u.photoURL||''}" class="h-8 w-8 rounded-full" alt=""/>
              <div>
                <div class="font-semibold">${u.displayName||u.email||u.id}</div>
                <div class="text-xs opacity-80">${u.email||''}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <select class="rounded-xl border p-2" data-uid="${u.id}">
                ${ROLES.map(r=>`<option value="${r}" ${currentRole===r?'selected':''}>${r}</option>`).join('')}
              </select>
              <button class="btn btn-primary" data-save="${u.id}">Enregistrer</button>
            </div>
          `;
          li.addEventListener('click', async (e)=>{
            const s = e.target.closest('button[data-save]'); if(!s) return;
            const uid = s.dataset.save;
            const newRole = li.querySelector('select').value;
            await setDoc(doc(db,'roles', uid), { role: newRole, updatedAt: serverTimestamp() }, { merge: true });
          });
          ul.appendChild(li); revealify(li);
        }
      });
    }

    // ===== Inventory logic =====
    function wireInventories(role){
      // Inventory â€“ Tech
      if(role==='tech' || role==='admin' || role==='reception'){
        setupInventory('tech', '#formInvTech', '#listInvTech');
      }
      // Inventory â€“ Clean
      if(role==='clean' || role==='admin' || role==='reception'){
        setupInventory('clean', '#formInvClean', '#listInvClean');
      }

      function setupInventory(kind, formSel, listSel){
        const form = document.querySelector(formSel);
        const list = document.querySelector(listSel);
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(form);
          const name = (fd.get('name')||'').toString().trim();
          let qty = parseInt(fd.get('qty')||'1', 10) || 1;
          if(!name) return;
          await addDoc(collection(db, `inventory_${kind}`), { name, qty, createdAt: serverTimestamp() });
          form.reset();
        });
        onSnapshot(query(collection(db, `inventory_${kind}`), orderBy('createdAt','desc')), (qs)=>{
          list.innerHTML='';
          qs.forEach(d=>{
            const it = { id:d.id, ...d.data() };
            const li = document.createElement('li');
            li.className = 'rounded-xl border p-3 bg-white flex items-center justify-between gap-2';
            li.innerHTML = `
              <div class="font-semibold">${it.name}</div>
              <div class="flex items-center gap-2">
                <button class="btn btn-outline" data-act="dec">âˆ’1</button>
                <span class="w-8 text-center">${it.qty}</span>
                <button class="btn btn-outline" data-act="inc">+1</button>
                <button class="btn btn-primary" data-act="del">Supprimer</button>
              </div>
            `;
            li.addEventListener('click', async (e)=>{
              const b = e.target.closest('button[data-act]'); if(!b) return;
              const ref = doc(db, `inventory_${kind}`, it.id);
              if(b.dataset.act==='inc') await updateDoc(ref, { qty: (it.qty||0)+1 });
              if(b.dataset.act==='dec') await updateDoc(ref, { qty: Math.max(0, (it.qty||0)-1) });
              if(b.dataset.act==='del') await updateDoc(ref, { qty: -1 }).then(()=>{ /* flag for cleanup */ });
            });
            list.appendChild(li);
          });
        });
      }
    }
  </script>
</body>
</html>
