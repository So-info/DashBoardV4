<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>La Plage ‚Äî Intranet mobile</title>
<meta name="theme-color" content="#38bdf8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
 <style>
  :root{
    --bg:#f5f9ff;        /* fond global tr√®s clair */
    --surface:#ffffff;   /* cartes, champs */
    --muted:#637189;     /* texte secondaire */
    --text:#0f172a;      /* texte principal */
    --brand:#38bdf8;     /* bleu ciel */
    --brand-2:#0ea5e9;   /* bleu ciel plus soutenu */
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --ring: rgba(56,189,248,.35);
    --line:#e6eef7;      /* traits et bords */
    --shadow: 0 8px 28px rgba(2,6,23,.06);
    --shadow-lg: 0 14px 40px rgba(2,6,23,.10);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text);
    background:
      radial-gradient(120% 120% at 0% 0%, #f0f8ff 0%, #f7fbff 45%, #ffffff 100%);
  }
  .container{max-width:820px;margin:0 auto;padding:clamp(12px,2.5vw,24px)}

  /* ===== App shell (clair) ===== */
  header{
    position:sticky; top:0; z-index:30; background:#ffffffcc; backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line); box-shadow:var(--shadow);
  }
  .nav{display:flex;align-items:center;gap:10px;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
  .brand .logo{
    width:36px;height:36px;border-radius:10px;
    background:radial-gradient(120% 120% at 100% 0, #bfe9ff, #7dd3fc 40%, #38bdf8 60%, #0ea5e9 100%);
    box-shadow:0 10px 22px rgba(56,189,248,.35);
  }
  .spacer{flex:1}
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);
    border-radius:999px;background:#f8fbff;color:#0b2440;font-weight:600;
  }

  /* Boutons */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px;border-radius:16px;border:1px solid var(--line);
    background:linear-gradient(180deg,#ffffff,#f8fbff);
    color:var(--text); text-decoration:none; font-weight:700;
    box-shadow:var(--shadow); transition:transform .08s ease, box-shadow .2s ease, filter .15s ease;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow-lg)}
  .btn:active{transform:translateY(0)}
  .btn.primary{
    background:linear-gradient(180deg, var(--brand), var(--brand-2));
    color:#063246; border-color:rgba(56,189,248,.5); box-shadow:0 10px 26px rgba(56,189,248,.35);
  }
  .btn.primary:hover{filter:brightness(1.03); box-shadow:0 14px 36px rgba(56,189,248,.45)}
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 10px;border-radius:12px;font-size:.92rem}
  .btn.icon{width:40px;height:40px;padding:0;border-radius:12px}
  .back{
    display:none;align-items:center;gap:8px;padding:10px;border-radius:12px;
    border:1px solid var(--line); background:linear-gradient(180deg,#ffffff,#f8fbff); font-weight:600;
    box-shadow:var(--shadow);
  }
  .back.show{display:inline-flex}

  /* Cartes */
  .grid{display:grid;gap:12px}
  .grid.cards{grid-template-columns:1fr}
  @media(min-width:640px){.grid.cards{grid-template-columns:repeat(2,1fr)}}
  .card{
    background:var(--surface); border:1px solid var(--line); border-radius:20px;
    padding:16px; box-shadow:var(--shadow); transition:transform .2s ease, box-shadow .2s ease;
  }
  .card:hover{transform:translateY(-1px); box-shadow:var(--shadow-lg)}
  .card h3{margin:4px 0 8px 0;font-size:1.08rem}
  .muted{color:var(--muted)}

  /* Champs */
  input, select, textarea{
    width:100%; padding:12px; border-radius:14px; background:#fff; border:1px solid #dfe8f3; color:var(--text);
    outline:none; transition:border-color .2s ease, box-shadow .2s ease, background .2s ease;
  }
  input:focus, select:focus, textarea:focus{border-color:var(--brand-2); box-shadow:0 0 0 4px var(--ring)}
  textarea{min-height:90px}
  .field{display:grid;gap:6px;margin:10px 0}
  .row{display:flex;gap:8px}
  .row > *{flex:1}

  /* Tags / statuts */
  .tag{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:.85rem;background:#f7fbff}
  .status{font-weight:800;letter-spacing:.2px}
  .status.todo{color:var(--bad)}
  .status.doing{color:var(--warn)}
  .status.done{color:var(--ok)}
  .list{display:grid;gap:10px}
  .item{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px;border:1px dashed #dfe8f3;border-radius:14px;background:#fff}
  .qty{font-weight:800}
  .chip{padding:8px 10px;border-radius:999px;background:#e6f7ff;border:1px solid #bee7fb;color:#075985;font-weight:700}
  .danger{color:#b91c1c}
  .divider{height:1px;background:linear-gradient(90deg,transparent,#e9f1fa,transparent);margin:10px 0}
  footer{opacity:.75;font-size:.9rem;text-align:center;padding:86px 0 20px}

  /* Transitions d‚Äô√©cran */
  section[id^="screen-"]{display:none;transform:translateX(16px);opacity:0;transition:transform .25s ease, opacity .25s ease}
  section[id^="screen-"].active{display:block;transform:translateX(0);opacity:1}

  /* Barre d‚Äôonglets (bas) */
  .tabbar{
    position:fixed;left:0;right:0;bottom:0;z-index:40;background:#ffffffcc; backdrop-filter:blur(12px);
    border-top:1px solid var(--line); box-shadow:0 -6px 20px rgba(2,6,23,.06);
  }
  .tabs{max-width:820px;margin:0 auto;padding:10px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .tab{
    display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px;border-radius:14px;border:1px solid transparent;
    text-align:center;font-size:.78rem;color:#0b2440; background:transparent; transition:border-color .2s ease, background .2s ease;
  }
  .tab.active{border-color:#bfe7fb;background:linear-gradient(180deg,#eef9ff,#e6f6ff)}
  .hidden{display:none !important}
  .ring{box-shadow:0 0 0 4px var(--ring)}
</style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><div class="logo"></div> La Plage ‚Äî Intranet</div>
      <button id="backBtn" class="back">‚üµ Retour</button>
      <div id="rolePill" class="pill hidden"></div>
      <div class="spacer"></div>
      <button id="signinBtn" class="btn primary">Connexion Google</button>
      <button id="signoutBtn" class="btn ghost hidden">Se d√©connecter</button>
    </div>
  </header>

  <main class="container">
    <!-- DASHBOARD -->
    <section id="screen-dashboard" class="grid cards active">
      <div class="card">
        <h3>Bienvenue üëã</h3>
        <p class="muted">S√©lectionnez une section ci-dessous. Votre r√¥le : <span id="roleLabel">‚Äî</span></p>
        <div class="divider"></div>
        <div id="quickLinks" class="grid cards"></div>
      </div>
      <div class="card">
        <h3>Interventions r√©centes</h3>
        <div id="recentInterventions" class="list"></div>
      </div>
    </section>

    <!-- RECEPTION -->
    <section id="screen-reception">
      <div class="card ring">
        <h3>Nouvelle intervention (Technique)</h3>
        <div class="field">
          <label>N¬∞ Mobil-home</label>
          <input id="i_mh" placeholder="ex: B12" />
        </div>
        <div class="row">
          <div class="field">
            <label>Statut</label>
            <select id="i_status">
              <option value="todo">√Ä faire</option>
              <option value="doing">En cours</option>
              <option value="done">Termin√©</option>
            </select>
          </div>
          <div class="field">
            <label>Clients pr√©sents</label>
            <select id="i_present">
              <option value="oui">Oui</option>
              <option value="non">Non</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Client autorise l'intervention</label>
            <select id="i_ok">
              <option value="oui">Oui</option>
              <option value="non">Non</option>
            </select>
          </div>
          <div class="field">
            <label>Assign√© √†</label>
            <select id="i_team" disabled>
              <option value="technique" selected>Technique</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>D√©tail (si besoin)</label>
          <textarea id="i_details" placeholder="Pr√©cisions‚Ä¶"></textarea>
        </div>
        <div class="row">
          <button id="btnCreateInter" class="btn primary">Enregistrer</button>
          <button id="btnClearInter" class="btn">R√©initialiser</button>
        </div>
      </div>
      <div class="card">
        <h3>Interventions ouvertes</h3>
        <div id="receptionInterventions" class="list"></div>
      </div>
    </section>

    <!-- TECHNIQUE -->
    <section id="screen-tech">
      <div class="card">
        <h3>Interventions (Technique)</h3>
        <div id="techInterventions" class="list"></div>
      </div>
    </section>

    <!-- MENAGE -->
    <section id="screen-menage">
      <div class="card">
        <h3>Informations / t√¢ches M√©nage</h3>
        <p class="muted">(√Ä adapter si vous souhaitez des tickets sp√©cifiques m√©nage)</p>
        <div id="menageInfo" class="list"></div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="screen-admin">
      <div class="card ring">
        <h3>Gestion des r√¥les</h3>
        <p class="muted">Attribuez un r√¥le aux salari√©s connect√©s au moins une fois. Les utilisateurs apparaissent automatiquement dans la liste ci-dessous apr√®s leur premi√®re connexion.</p>
        <div class="field">
          <label>Filtrer par nom / email</label>
          <input id="userSearch" placeholder="Rechercher‚Ä¶" />
        </div>
        <div id="userList" class="list"></div>
      </div>
    </section>

    <!-- INVENTAIRES -->
    <section id="screen-inventory-tech">
      <div class="card ring">
        <h3>Inventaire ‚Äî Technique</h3>
        <div class="row">
          <input id="it_name" placeholder="Nouvel objet‚Ä¶"/>
          <input id="it_qty" type="number" inputmode="numeric" placeholder="Qt√©"/>
          <button id="it_add" class="btn primary small">Ajouter</button>
        </div>
        <div id="it_list" class="list" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="screen-inventory-menage">
      <div class="card ring">
        <h3>Inventaire ‚Äî M√©nage</h3>
        <div class="row">
          <input id="im_name" placeholder="Nouvel objet‚Ä¶"/>
          <input id="im_qty" type="number" inputmode="numeric" placeholder="Qt√©"/>
          <button id="im_add" class="btn primary small">Ajouter</button>
        </div>
        <div id="im_list" class="list" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- ACCESS DENIED -->
    <section id="screen-denied">
      <div class="card">
        <h3>Acc√®s restreint</h3>
        <p class="muted">Demandez √† l'administrateur de vous attribuer un r√¥le.</p>
      </div>
    </section>
  </main>

  <!-- Bottom Tabbar -->
  <nav id="tabbar" class="tabbar hidden">
    <div id="tabs" class="tabs"></div>
  </nav>

  <footer>
    <div class="container">¬© <span id="year"></span> Camping La Plage ‚Äî Acc√®s √©quipes</div>
  </footer>

  <!-- Firebase (Compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // 1) CONFIG FIREBASE (la tienne)
    const firebaseConfig = {
      apiKey: "AIzaSyDEVzQfz8loSf2HDzU_YcBvIgH1Fx9_fnw",
      authDomain: "dashboard-v4-2ef47.firebaseapp.com",
      projectId: "dashboard-v4-2ef47",
      storageBucket: "dashboard-v4-2ef47.firebasestorage.app",
      messagingSenderId: "179267988381",
      appId: "1:179267988381:web:644c3a2dc713ed9bca1d74"
    };

    // 2) INIT
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 3) UTILITES UI
    const $ = (id)=>document.getElementById(id);
    const fmtStatus = (s)=> s==='todo'?'<span class="status todo">√Ä faire</span>':(s==='doing'?'<span class="status doing">En cours</span>':'<span class="status done">Termin√©</span>');

    const SCREENS = [
      'screen-dashboard','screen-reception','screen-tech','screen-menage',
      'screen-admin','screen-inventory-tech','screen-inventory-menage','screen-denied'
    ];

    // Router avec transitions + historique
    const historyStack = [];
    function route(to){
      SCREENS.forEach(id=>{
        const el=$(id);
        el.classList.remove('active');
        el.style.display='none';
      });
      const next=$(to);
      next.style.display='block';
      requestAnimationFrame(()=>next.classList.add('active'));
      window.scrollTo({top:0,behavior:'smooth'});
      if(historyStack[historyStack.length-1]!==to){ historyStack.push(to); }
      updateBack();
    }
    function goBack(){
      historyStack.pop();
      const prev = historyStack.pop() || 'screen-dashboard';
      route(prev);
      selectTab(prev);
    }
    $('backBtn').onclick = goBack;
    function updateBack(){ $('backBtn').classList.toggle('show', historyStack.length>1); }

    function selectTab(scr){
      document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x.dataset.tab===scr));
    }

    // 4) AUTH
    $('signinBtn').onclick = async ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      await auth.signInWithPopup(provider);
    };
    $('signoutBtn').onclick = ()=> auth.signOut();

    let currentUser = null; let currentRole = null;
    let unsubInter=null, unsubTech=null, unsubIT=null, unsubIM=null, unsubUsers=null;

    auth.onAuthStateChanged(async (user)=>{
      currentUser = user || null;
      if(!user){
        $('signoutBtn').classList.add('hidden');
        $('signinBtn').classList.remove('hidden');
        $('rolePill').classList.add('hidden');
        $('roleLabel').textContent = '‚Äî';
        $('quickLinks').innerHTML=''; $('recentInterventions').innerHTML='';
        [unsubInter,unsubTech,unsubIT,unsubIM,unsubUsers].forEach(u=>u && u());
        route('screen-dashboard');
        $('tabbar').classList.add('hidden');
        return;
      }

      $('signoutBtn').classList.remove('hidden');
      $('signinBtn').classList.add('hidden');

      // Cr√©er/MAJ profil minimal
      const profRef = db.collection('users').doc(user.uid);
      await profRef.set({
        uid:user.uid, displayName:user.displayName || '', email:user.email || '', photoURL:user.photoURL || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});

      // Charger r√¥le
      const roleDoc = await db.collection('roles').doc(user.uid).get();
      currentRole = roleDoc.exists ? roleDoc.data().role : null;

      $('roleLabel').textContent = currentRole || 'non d√©fini';
      $('rolePill').textContent = (user.displayName||user.email) + (currentRole? ' ‚Äî '+currentRole.toUpperCase() : ' ‚Äî r√¥le √† attribuer');
      $('rolePill').classList.remove('hidden');

      buildDashboard();
      wireRealtime();
    });

    // 5) DASHBOARD + onglets bas selon r√¥le
    function buildDashboard(){
      const links = [];
      if(!currentUser){ route('screen-dashboard'); return; }
      const tabs = [];

      if(currentRole==='admin'){
        links.push({t:'Administration',scr:'screen-admin'});
        links.push({t:'R√©ception ‚Äî Interventions',scr:'screen-reception'});
        links.push({t:'Technique ‚Äî Interventions',scr:'screen-tech'});
        links.push({t:'Inventaire Technique',scr:'screen-inventory-tech'});
        links.push({t:'Inventaire M√©nage',scr:'screen-inventory-menage'});
        tabs.push('screen-dashboard','screen-admin','screen-reception','screen-tech','screen-inventory-tech');
      } else if(currentRole==='reception'){
        links.push({t:'R√©ception ‚Äî Interventions',scr:'screen-reception'});
        tabs.push('screen-dashboard','screen-reception');
      } else if(currentRole==='technique'){
        links.push({t:'Technique ‚Äî Interventions',scr:'screen-tech'});
        links.push({t:'Inventaire Technique',scr:'screen-inventory-tech'});
        tabs.push('screen-dashboard','screen-tech','screen-inventory-tech');
      } else if(currentRole==='menage'){
        links.push({t:'M√©nage ‚Äî Tableau',scr:'screen-menage'});
        links.push({t:'Inventaire M√©nage',scr:'screen-inventory-menage'});
        tabs.push('screen-dashboard','screen-menage','screen-inventory-menage');
      } else {
        links.push({t:"Acc√®s restreint ‚Äî contacter l'admin", scr:'screen-denied'});
      }

      $('quickLinks').innerHTML = links.map(l=>`<a class="btn" data-goto="${l.scr}">${l.t}</a>`).join('');
      Array.from(document.querySelectorAll('[data-goto]')).forEach(a=>{
        a.onclick=()=>{ route(a.dataset.goto); selectTab(a.dataset.goto); }
      });

      // Bottom tabs
      if(tabs.length){
        const mapTitle = {
          'screen-dashboard':'Accueil','screen-admin':'Admin','screen-reception':'R√©ception',
          'screen-tech':'Technique','screen-menage':'M√©nage','screen-inventory-tech':'Inv. Tech',
          'screen-inventory-menage':'Inv. M√©nage'
        };
        $('tabs').innerHTML = tabs.map(scr=>`<button class="tab" data-tab="${scr}">${mapTitle[scr]}</button>`).join('');
        $('tabbar').classList.remove('hidden');
        document.querySelectorAll('[data-tab]').forEach(t=>{
          t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); route(t.dataset.tab); };
        });
        document.querySelector('[data-tab]')?.classList.add('active');
      } else {
        $('tabbar').classList.add('hidden');
      }

      route('screen-dashboard'); selectTab('screen-dashboard');
    }

    // 6) TEMPS R√âEL
    function wireRealtime(){
      // Dashboard r√©cents
      unsubInter && unsubInter();
      unsubInter = db.collection('interventions').orderBy('createdAt','desc').limit(10)
        .onSnapshot(snap=>{
          $('recentInterventions').innerHTML = snap.empty? '<span class="muted">Aucune intervention</span>' :
            snap.docs.map(d=>renderInterCard(d.data(), d.id, {compact:true})).join('');
        });

      // R√©ception
      unsubTech && unsubTech();
      unsubTech = db.collection('interventions').where('team','==','technique').orderBy('createdAt','desc')
        .onSnapshot(snap=>{
          $('receptionInterventions').innerHTML = snap.empty? '<span class="muted">‚Äî</span>' :
            snap.docs.map(d=>renderInterCard(d.data(), d.id, {showReception:true})).join('');
          bindInterButtons();
        });

      // Inventaire Technique
      unsubIT && unsubIT();
      unsubIT = db.collection('inventaires').doc('technique').collection('items').orderBy('name')
        .onSnapshot(snap=>{
          $('it_list').innerHTML = snap.empty? '<span class="muted">Aucun objet</span>' :
            snap.docs.map(doc=>renderInvItem(doc.id, doc.data(), 'technique')).join('');
          bindInvButtons('technique');
        });

      // Inventaire M√©nage
      unsubIM && unsubIM();
      unsubIM = db.collection('inventaires').doc('menage').collection('items').orderBy('name')
        .onSnapshot(snap=>{
          $('im_list').innerHTML = snap.empty? '<span class="muted">Aucun objet</span>' :
            snap.docs.map(doc=>renderInvItem(doc.id, doc.data(), 'menage')).join('');
          bindInvButtons('menage');
        });

      // Admin ‚Äî utilisateurs
      unsubUsers && unsubUsers();
      unsubUsers = db.collection('users').orderBy('displayName')
        .onSnapshot(snap=>{
          const q = ($('userSearch').value||'').toLowerCase();
          const rows = [];
          snap.forEach(doc=>{
            const u=doc.data();
            if(q && !(u.displayName||'').toLowerCase().includes(q) && !(u.email||'').toLowerCase().includes(q)) return;
            rows.push(u);
          });
          renderUserList(rows);
        });
    }

    // 7) CR√âER INTERVENTION
    $('btnCreateInter').onclick = async ()=>{
      if(!currentUser) return alert('Connectez-vous');
      if(!(currentRole==='reception' || currentRole==='admin')) return alert('Acc√®s r√©ception requis');
      const data = {
        mh: $('i_mh').value.trim(),
        status: $('i_status').value,
        present: $('i_present').value==='oui',
        authorize: $('i_ok').value==='oui',
        details: $('i_details').value.trim(),
        team: 'technique',
        createdBy: {uid: currentUser.uid, name: currentUser.displayName || currentUser.email},
        validatedBy: null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if(!data.mh) return alert('N¬∞ Mobil-home requis');
      await db.collection('interventions').add(data);
      ['i_mh','i_details'].forEach(id=>$(id).value='');
      $('i_status').value='todo'; $('i_present').value='oui'; $('i_ok').value='oui';
      alert('Intervention enregistr√©e');
    };
    $('btnClearInter').onclick = ()=>{ ['i_mh','i_details'].forEach(id=>$(id).value=''); };

    // 8) INVENTAIRE
    $('it_add').onclick = ()=> addInv('technique', $('it_name').value, Number($('it_qty').value||0));
    $('im_add').onclick = ()=> addInv('menage', $('im_name').value, Number($('im_qty').value||0));

    async function addInv(team, name, qty){
      if(!currentUser) return alert('Connectez-vous');
      if(!(currentRole===team || currentRole==='admin')) return alert('Acc√®s '+team+' requis');
      name = (name||'').trim(); if(!name) return alert('Nom requis');
      qty = isNaN(qty)?0:qty;
      const ref = db.collection('inventaires').doc(team).collection('items').doc(name.toLowerCase());
      await db.runTransaction(async (t)=>{
        const snap = await t.get(ref);
        const cur = snap.exists? (snap.data().qty||0) : 0;
        t.set(ref, {name, qty: cur + qty, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
      });
      if(team==='technique'){ $('it_name').value=''; $('it_qty').value=''; } else { $('im_name').value=''; $('im_qty').value=''; }
    }

    function bindInvButtons(team){
      document.querySelectorAll(`[data-inv-action][data-team="${team}"]`).forEach(btn=>{
        btn.onclick = async ()=>{
          if(!(currentRole===team || currentRole==='admin')) return alert('Acc√®s '+team+' requis');
          const id = btn.dataset.id; const act = btn.dataset.invAction;
          const ref = db.collection('inventaires').doc(team).collection('items').doc(id);
          if(act==='del'){
            const ok = confirm('Supprimer cet objet ?'); if(!ok) return;
            await ref.delete();
          } else {
            const delta = act==='plus'? 1 : -1;
            await db.runTransaction(async (t)=>{
              const snap = await t.get(ref);
              if(!snap.exists) return;
              let q = (snap.data().qty||0) + delta; if(q<0) q=0;
              t.update(ref,{qty:q, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
            });
          }
        }
      })
    }

    // 9) INTERVENTIONS
    function renderInvItem(id, d, team){
      return `<div class="item">
        <div><div style="font-weight:600">${d.name}</div><div class="muted">ID: ${id}</div></div>
        <div class="row" style="justify-content:flex-end;gap:6px;align-items:center">
          <span class="qty">${d.qty||0}</span>
          <button class="btn small" data-team="${team}" data-id="${id}" data-inv-action="minus">‚àí</button>
          <button class="btn small" data-team="${team}" data-id="${id}" data-inv-action="plus">+</button>
          <button class="btn small danger" data-team="${team}" data-id="${id}" data-inv-action="del">Supprimer</button>
        </div>
      </div>`;
    }

    function renderInterCard(d, id, {compact=false, showReception=false}={}){
      const who = d.validatedBy? `<span class="chip">Valid√© par ${d.validatedBy.name}</span>` : '';
      return `<div class="card">
        <h3>MH ${d.mh} ‚Äî ${fmtStatus(d.status)}</h3>
        <div class="muted">Cr√©√© par ${d.createdBy?.name||'‚Äî'} ‚Ä¢ ${d.team==='technique'?'Technique':''}</div>
        ${d.details? `<p style="margin:8px 0">${d.details}</p>`:''}
        <div class="row">
          <span class="tag">Clients pr√©sents: ${d.present?'Oui':'Non'}</span>
          <span class="tag">Autorisation: ${d.authorize?'Oui':'Non'}</span>
          ${who}
        </div>
        <div class="row" style="margin-top:10px">
          ${compact? '' : actionButtons(d,id,showReception)}
        </div>
      </div>`
    }

    function actionButtons(d, id, showReception){
      const btns = [];
      if(showReception && (currentRole==='reception' || currentRole==='admin')){
        ['todo','doing','done'].forEach(s=>{
          btns.push(`<button class="btn small" data-inter-act="status" data-id="${id}" data-val="${s}">${s==='todo'?'√Ä faire':(s==='doing'?'En cours':'Termin√©')}</button>`);
        });
      }
      if(currentRole==='technique' || currentRole==='admin'){
        btns.push(`<button class="btn small" data-inter-act="take" data-id="${id}">Valider (je prends)</button>`);
        ['todo','doing','done'].forEach(s=>{
          btns.push(`<button class="btn small" data-inter-act="status" data-id="${id}" data-val="${s}">${s==='todo'?'√Ä faire':(s==='doing'?'En cours':'Termin√©')}</button>`);
        });
      }
      return btns.join(' ');
    }

    function bindInterButtons(){
      document.querySelectorAll('[data-inter-act]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.dataset.id; const act = btn.dataset.interAct; const ref = db.collection('interventions').doc(id);
          const snap = await ref.get(); if(!snap.exists) return;
          if(act==='take'){
            if(!(currentRole==='technique' || currentRole==='admin')) return alert('R√©serv√© √† la technique');
            await ref.update({validatedBy:{uid: currentUser.uid, name: currentUser.displayName||currentUser.email}, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
          }
          if(act==='status'){
            const val = btn.dataset.val;
            if(!(currentRole==='reception' || currentRole==='technique' || currentRole==='admin')) return alert('Acc√®s requis');
            await ref.update({status: val, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
          }
        }
      })
    }

    // Vue Technique en temps r√©el
    db.collection('interventions').where('team','==','technique').orderBy('createdAt','desc')
      .onSnapshot(snap=>{
        $('techInterventions').innerHTML = snap.empty? '<span class="muted">Aucune</span>' :
          snap.docs.map(d=>renderInterCard(d.data(), d.id)).join('');
        bindInterButtons();
      });

    // Admin
    $('userSearch').oninput = ()=> wireRealtime();

    function renderUserList(users){
      $('userList').innerHTML = users.map(u=>{
        const id = u.uid;
        return `<div class="item">
          <div>
            <div style="font-weight:600">${u.displayName||'‚Äî'}</div>
            <div class="muted">${u.email||''}</div>
          </div>
          <div class="row" style="align-items:center;gap:6px">
            <select id="role_${id}">
              <option value="">‚Äî r√¥le ‚Äî</option>
              <option value="admin">admin</option>
              <option value="reception">reception</option>
              <option value="technique">technique</option>
              <option value="menage">menage</option>
            </select>
            <button class="btn small" data-role-save="${id}">Enregistrer</button>
          </div>
        </div>`
      }).join('');

      users.forEach(async (u)=>{
        const r = await db.collection('roles').doc(u.uid).get();
        if(r.exists){ const v=r.data().role; const el=$('role_'+u.uid); if(el) el.value=v; }
      });

      document.querySelectorAll('[data-role-save]').forEach(btn=>{
        btn.onclick = async ()=>{
          if(!(currentRole==='admin')) return alert('Acc√®s admin requis');
          const uid = btn.dataset.roleSave; const role = $('role_'+uid).value;
          if(!role) return alert('Choisissez un r√¥le');
          await db.collection('roles').doc(uid).set({role, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
          alert('R√¥le enregistr√©');
        }
      })
    }

    // Footer
    $('year').textContent = new Date().getFullYear();

    // Navigation par #hash (facultatif)
    window.addEventListener('hashchange',()=>{
      const h = location.hash.replace('#','');
      if(SCREENS.includes(h)){ route(h); selectTab(h); }
    });
  </script>
</body>
</html>

